---
import BaseLayout from '../../layouts/BaseLayout.astro';
import GenericHero from '../../components/GenericHero.astro';
import DscrCalculator from '../../components/DscrCalculator';
import RefinanceCalculator from '../../components/RefinanceCalculator';
import PurchaseSections from '../../components/program-sections/PurchaseSections.astro';
import RefinanceSections from '../../components/program-sections/RefinanceSections.astro';
import DscrSections from '../../components/program-sections/DscrSections.astro';
import ConventionalSections from '../../components/program-sections/ConventionalSections.astro';
import FhaSections from '../../components/program-sections/FhaSections.astro';
import VaSections from '../../components/program-sections/VaSections.astro';
import HelocSections from '../../components/program-sections/HelocSections.astro';
import UsdaSections from '../../components/program-sections/UsdaSections.astro';
import Fha203kSections from '../../components/program-sections/Fha203kSections.astro';
import NonQmSections from '../../components/program-sections/NonQmSections.astro';
import CommercialSections from '../../components/program-sections/CommercialSections.astro';
import EquitySelectSections from '../../components/program-sections/EquitySelectSections.astro';
import ReverseMortgageSections from '../../components/program-sections/ReverseMortgageSections.astro';
import JumboSections from '../../components/program-sections/JumboSections.astro';
import ConstructionSections from '../../components/program-sections/ConstructionSections.astro';
import { allPageData, sitemap } from '../../data/sitemap';
import { heroImageAssignments, pageHeroImageKeys } from '../../data/imageAssignments';
import type { PageData } from '../../data/types';

export interface Props {
  pageData: PageData;
  programPath: string;
}

export async function getStaticPaths() {
  return sitemap.loanPrograms.map((program) => {
    const slug = program.path.replace('/loan-programs/', '');
    return {
      params: { slug },
      props: {
        programPath: program.path,
      },
    };
  });
}

const { programPath } = Astro.props as Props;
const pageData = allPageData[programPath];

if (!pageData) {
  throw new Error(`Loan program not found for path: ${programPath}`);
}

const heroKey = pageHeroImageKeys[programPath];
const fallbackHero = heroImageAssignments.loanProgramsHero;
const heroAssignment = heroKey ? heroImageAssignments[heroKey] : undefined;
const heroImageAssignment = heroAssignment ?? (pageData.imageUrl ? undefined : fallbackHero);
const heroImageUrl = heroImageAssignment?.src ?? pageData.imageUrl ?? fallbackHero.src;
const heroImageAlt = heroImageAssignment?.alt ?? pageData.imageAlt ?? fallbackHero.alt;
const pageTitleForCta = pageData.title.split('|')[0]?.trim() ?? pageData.h1;
const programDetails = pageData.programDetails;
const benefits = programDetails?.benefits ?? [];
const eligibility = programDetails?.eligibility ?? [];
const howItWorks = programDetails?.howItWorks ?? [];

const isPurchase = programPath === '/loan-programs/purchase';
const isRefinance = programPath === '/loan-programs/refinance';
const isDscr = programPath === '/loan-programs/dscr';
const isHeloc = programPath === '/loan-programs/heloc';
const isConventional = programPath === '/loan-programs/conventional';
const isFha = programPath === '/loan-programs/fha';
const isVa = programPath === '/loan-programs/va';
const isUsda = programPath === '/loan-programs/usda';
const isFha203k = programPath === '/loan-programs/fha-203k';
const isNonQm = programPath === '/loan-programs/non-qm';
const isCommercial = programPath === '/loan-programs/commercial';
const isEquitySelect = programPath === '/loan-programs/equity-select';
const isReverse = programPath === '/loan-programs/reverse-mortgage';
const isJumbo = programPath === '/loan-programs/jumbo';
const isConstruction = programPath === '/loan-programs/construction';
---
<BaseLayout pageData={pageData}>
  <GenericHero
    title={pageData.h1}
    subtitle={pageData.description}
    imageUrl={heroImageUrl}
    imageAlt={heroImageAlt}
    image={heroImageAssignment}
    imageObjectClassName="object-cover object-center"
  />

  {programDetails && (
    <section class="bg-white py-16 sm:py-20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] gap-12 items-start">
          <div>
            <p class="text-sm font-semibold uppercase tracking-wide text-[#09143e]">Program Overview</p>
            <h2 class="mt-2 text-3xl font-bold text-gray-900">{pageData.h1}</h2>
            <p class="mt-4 text-lg text-gray-600">{programDetails.summary}</p>

            {benefits.length > 0 && (
              <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-800">Key Benefits</h3>
                <ul class="mt-4 space-y-3">
                  {benefits.map((benefit, index) => (
                    <li class="flex items-start" key={index}>
                      <span class="text-[#bf9f5c] font-bold mr-3">&raquo;</span>
                      <span class="text-gray-700">{benefit}</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>

          {eligibility.length > 0 && (
            <div class="bg-gray-50 p-8 rounded-lg shadow-lg border border-gray-200">
              <h3 class="text-2xl font-bold text-gray-900">Who is this for?</h3>
              <p class="mt-3 text-gray-600">
                This loan may be a great fit if you meet the following general criteria:
              </p>
              <ul class="mt-6 space-y-4">
                {eligibility.map((item, index) => (
                  <li class="flex items-start" key={index}>
                    <span class="text-[#09143e] font-bold mr-3">&raquo;</span>
                    <span class="text-gray-700">{item}</span>
                  </li>
                ))}
              </ul>
              <p class="mt-6 text-xs text-gray-500">
                These are general guidelines. Contact us for a personalized assessment. Not a commitment to lend.
              </p>
            </div>
          )}
        </div>
      </div>
    </section>
  )}

  {isDscr && <DscrSections />}

  {isPurchase && <PurchaseSections />}
  {isConventional && <ConventionalSections />}
  {isFha && <FhaSections />}
  {isVa && <VaSections />}
  {isHeloc && <HelocSections />}
  {isUsda && <UsdaSections />}
  {isFha203k && <Fha203kSections />}
  {isNonQm && <NonQmSections />}
  {isCommercial && <CommercialSections />}
  {isEquitySelect && <EquitySelectSections />}
  {isReverse && <ReverseMortgageSections />}
  {isJumbo && <JumboSections />}
  {isConstruction && <ConstructionSections />}

  {howItWorks.length > 0 && (
    <section class="bg-gray-50 py-16 sm:py-20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-3xl mx-auto">
          <p class="text-sm font-semibold uppercase tracking-wide text-[#09143e]">How It Works</p>
          <h2 class="mt-2 text-3xl font-bold text-gray-900">
            A Clear Path from Application to Closing
          </h2>
        </div>
        <div class="mt-12 relative">
          <div class="absolute top-0 left-12 w-0.5 h-full bg-gray-200 hidden md:block" aria-hidden="true"></div>
          <div class="space-y-12">
            {howItWorks.map((step, index) => (
              <div class="md:flex items-start" key={step.title}>
                <div class="flex-shrink-0 w-24 flex justify-center">
                  <span class={`w-12 h-12 ${index === howItWorks.length - 1 ? 'bg-[#bf9f5c]' : 'bg-[#09143e]'} text-white font-bold text-lg rounded-full flex items-center justify-center ring-8 ring-white z-10`}>
                    {index === howItWorks.length - 1 ? (
                      <i class="fa-solid fa-flag-checkered" aria-hidden="true"></i>
                    ) : (
                      index + 1
                    )}
                  </span>
                </div>
                <div class="ml-4 md:ml-8 mt-4 md:mt-0">
                  <h3 class="font-bold text-lg text-gray-800">{step.title}</h3>
                  <p class="mt-2 text-gray-600">{step.description}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>
  )}

  {isRefinance && (
    <section class="bg-white py-16 sm:py-20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-3xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900">Mortgage Refinance Savings Calculator</h2>
          <p class="mt-4 text-lg text-gray-600">
            Model your current mortgage against different refinance scenarios, including closing costs, rates, terms, and optional cash-out or cash-in strategies.
          </p>
        </div>
        <div class="mt-12">
          <RefinanceCalculator client:load />
        </div>
      </div>
    </section>
  )}

  {isRefinance && <RefinanceSections />}

  {isDscr && (
    <section class="bg-white py-16 sm:py-20">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center max-w-3xl mx-auto">
          <h2 class="text-3xl font-bold text-gray-900">DSCR Calculator</h2>
          <p class="mt-4 text-lg text-gray-600">
            Evaluate rental income against monthly debt payments to understand program eligibility and cash-flow fit.
          </p>
        </div>
        <div class="mt-12">
          <DscrCalculator client:load />
        </div>
      </div>
    </section>
  )}

  <section class="bg-[#09143e]">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16 text-center">
      <h2 class="text-3xl font-bold text-white">Ready to Get Started?</h2>
      <p class="mt-4 text-lg text-gray-200 max-w-2xl mx-auto">
        Find out if a {pageTitleForCta} is right for you. Get a no-obligation quote from our experts today.
      </p>
      <a
        href="/get-a-quote"
        class="mt-8 inline-block bg-white text-[#09143e] font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-gray-100 transition duration-300"
      >
        Request a Free Quote
      </a>
    </div>
  </section>
</BaseLayout>
