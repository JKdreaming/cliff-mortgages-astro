---
import '../styles/global.css';
import type { PageData } from '../data/types';
import cliffmortgagesLogo from '../assets/images/cliffmortgages-logo.webp';
import Footer from '../components/Footer.astro';

interface Props {
  pageData: PageData;
}

const { pageData } = Astro.props;
const SITE_BASE_URL = 'https://cliffmortgages.com';
const DEFAULT_SOCIAL_IMAGE_URL = `${SITE_BASE_URL}/cliff-default-social-share-image.jpg`;

const sanitizePath = (path: string | undefined) => {
  if (!path) return '/';
  if (path.startsWith('http')) return path;
  return path.startsWith('/') ? path : `/${path}`;
};

const canonicalUrl = (() => {
  if (!pageData.path) return SITE_BASE_URL;
  if (pageData.path.startsWith('http')) return pageData.path;
  return `${SITE_BASE_URL}${sanitizePath(pageData.path)}`;
})();

const resolveAbsoluteUrl = (url: string) => {
  if (!url) return DEFAULT_SOCIAL_IMAGE_URL;
  if (url.startsWith('http')) return url;
  return `${SITE_BASE_URL}${sanitizePath(url)}`;
};

const BRAND_SUFFIX = 'Cliff Mortgages / C2 Financial / Colorado Mortgage Broker';
const LEGACY_SUFFIX_PATTERN = /\s*\|\s*Cliff Mortgages\b/;

const normalizeTitle = (rawTitle: string) => {
  if (!rawTitle) return BRAND_SUFFIX;
  if (rawTitle.includes(BRAND_SUFFIX)) return rawTitle;
  if (LEGACY_SUFFIX_PATTERN.test(rawTitle)) {
    return rawTitle.replace(LEGACY_SUFFIX_PATTERN, ` / ${BRAND_SUFFIX}`);
  }
  return `${rawTitle} | ${BRAND_SUFFIX}`;
};

const normalisedTitle = normalizeTitle(pageData.title);
const metaDescription = pageData.seoDescription ?? pageData.description;
const socialImage = resolveAbsoluteUrl(pageData.seoImageUrl ?? DEFAULT_SOCIAL_IMAGE_URL);

const faqSchema = pageData.faqs?.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'FAQPage',
      mainEntity: pageData.faqs.map((faq) => ({
        '@type': 'Question',
        name: faq.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: faq.answer,
        },
      })),
    }
  : null;

const breadcrumbSchema = pageData.breadcrumbs?.length
  ? {
      '@context': 'https://schema.org',
      '@type': 'BreadcrumbList',
      itemListElement: pageData.breadcrumbs.map((crumb, index) => ({
        '@type': 'ListItem',
        position: index + 1,
        name: crumb.name,
        item: `${SITE_BASE_URL}${sanitizePath(crumb.path)}`,
      })),
    }
  : null;

const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'MortgageBroker',
  name: 'Cliff Mortgages',
  url: SITE_BASE_URL,
  logo: `${SITE_BASE_URL}/cliffmortgages-logo.webp`,
  image: DEFAULT_SOCIAL_IMAGE_URL,
  telephone: '970-699-3900',
  email: 'cindy@cliffmortgages.com',
  address: {
    '@type': 'PostalAddress',
    streetAddress: '12230 El Camino Real, Suite 100',
    addressLocality: 'San Diego',
    addressRegion: 'CA',
    postalCode: '92130',
    addressCountry: 'US',
  },
  areaServed: {
    '@type': 'AdministrativeArea',
    name: 'Colorado',
  },
  sameAs: ['https://www.facebook.com/profile.php?id=61557149998918', 'https://www.linkedin.com/company/cliff-mortgages/'],
};

const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Cliff Mortgages',
  url: SITE_BASE_URL,
};

const webpageSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  '@id': `${canonicalUrl}#webpage`,
  url: canonicalUrl,
  name: normalisedTitle,
  description: metaDescription,
  inLanguage: 'en',
  primaryImageOfPage: {
    '@type': 'ImageObject',
    url: socialImage,
  },
  isPartOf: {
    '@type': 'WebSite',
    url: SITE_BASE_URL,
    name: 'Cliff Mortgages',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Cliff Mortgages',
    url: SITE_BASE_URL,
  },
};

const schemas = [webpageSchema, faqSchema, breadcrumbSchema, organizationSchema, websiteSchema].filter(Boolean);
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{normalisedTitle}</title>
    <meta name="description" content={metaDescription} />
    <meta name="title" content={normalisedTitle} />
    <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />
    <meta property="og:title" content={normalisedTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={socialImage} />
    <meta property="og:site_name" content="Cliff Mortgages" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={normalisedTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={socialImage} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="icon" type="image/png" href="/cliffmortgages-favicon.png" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link
      rel="preload"
      as="style"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      />
    </noscript>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RTE0P19P15"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      window.gtag = function gtag() {
        window.dataLayer.push(arguments);
      };
      window.gtag('js', new Date());
      window.gtag('config', 'G-RTE0P19P15');
    </script>
    {schemas.map((schema) => (
      <script type="application/ld+json" set:html={JSON.stringify(schema)}></script>
    ))}
  </head>
  <body class="bg-gray-50 min-h-screen font-sans text-gray-800">
    <div class="flex flex-col min-h-screen">
      <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center">
          <img
            src={cliffmortgagesLogo.src}
            alt="Cliff Mortgages Logo"
            class="h-10 w-auto rounded-[10px]"
            width="160"
            height="40"
            loading="eager"
          />
        </div>
      </header>
      <main class="flex-grow">
        <slot />
      </main>
      <Footer />
    </div>
  </body>
</html>
